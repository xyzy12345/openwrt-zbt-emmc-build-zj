name: Build ImmortalWrt 24.10.4 for ZBT-Z8102AX-eMMC (MT7981B)

on:
  push:
    branches: [ main, master, openwrt-24.10 ]
    paths:
      - 'configs/**'
      - 'dts/**'
      - 'patches/**'
      - 'target/linux/mediatek/**'
      - '.github/workflows/build-immortalwrt-24.10.yml'
  pull_request:
    branches: [ main, master, openwrt-24.10 ]
  schedule:
    - cron: '0 2 * * 0'  # 每周日UTC 2点自动构建
  workflow_dispatch:
    inputs:
      clean_build:
        description: '清除构建缓存（会显著增加编译时间）'
        required: false
        default: 'false'
      skip_download:
        description: '跳过下载阶段（使用已有dl缓存）'
        required: false
        default: 'false'

env:
  IMMORTALWRT_BRANCH: "openwrt-24.10"
  IMMORTALWRT_VERSION: "24.10.4"
  TARGET: "mediatek"
  SUBTARGET: "filogic"
  DEVICE: "zbtlink_z8102ax-emmc"
  # 根据你的分区信息调整（单位：MiB）
  EMMC_SYSTEM_SIZE: "7168"    # mmcblk0p6: 7G = 7168 MiB
  EMMC_ROOTFS_SIZE: "107520"  # mmcblk0p7: 105G ≈ 107520 MiB

jobs:
  build:
    runs-on: ubuntu-22.04  # 改为 22.04！GitHub Actions 对新版本支持不稳定，且工具链已验证。
    timeout-minutes: 300    # 延长超时时间，首次编译可能较久

    steps:
    - name: 检出自定义配置
      uses: actions/checkout@v4
      with:
        path: custom-configs
        fetch-depth: 0

    - name: 设置构建环境
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          python3-dev \
          rsync \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev \
          upx \
          cmake \
          pkg-config \
          flex \
          bison \
          curl

        # 配置ccache缓存
        sudo mkdir -p /opt/ccache
        sudo chmod 777 /opt/ccache
        echo "CCACHE_DIR=/opt/ccache" >> $GITHUB_ENV
        echo "/usr/lib/ccache" >> $GITHUB_PATH
        ccache -M 10G
        ccache -s

    - name: 克隆 ImmortalWrt 24.10.4 源码
      run: |
        echo "正在克隆 ImmortalWrt ${{ env.IMMORTALWRT_BRANCH }} 分支..."
        git clone https://github.com/immortalwrt/immortalwrt.git \
          --branch ${{ env.IMMORTALWRT_BRANCH }} \
          --single-branch \
          --depth=1

        cd immortalwrt

        # 验证分支版本（可选，用于调试）
        git log --oneline -3

        # 克隆子模块
        echo "初始化子模块..."
        git submodule update --init --recursive

        # 应用自定义DTS（根据你的分区信息优化）
        if [ -f ../custom-configs/dts/mt7981b-zbt-z8102ax-emmc.dts ]; then
          echo "复制并调整DTS文件以匹配你的分区布局..."
          mkdir -p target/linux/mediatek/dts/
          cp ../custom-configs/dts/mt7981b-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/

          # 可选：自动调整DTS中的分区大小
          sed -i "s/partition@6 {.*size = <0 .*>/partition@6 { label = \"ubi\"; reg = <0x6 0x1c00000>; }/" \
            target/linux/mediatek/dts/mt7981b-zbt-z8102ax-emmc.dts || true
        fi

        # 复制设备定义
        if [ -f ../custom-configs/target/linux/mediatek/image/filogic-emmc.mk ]; then
          echo "复制eMMC专用设备定义文件..."
          mkdir -p target/linux/mediatek/image/
          cp ../custom-configs/target/linux/mediatek/image/filogic-emmc.mk target/linux/mediatek/image/
        fi

    - name: 更新和安装软件源
      run: |
        cd immortalwrt

        # 添加重试逻辑以处理临时网络错误
        MAX_RETRIES=3
        RETRY_DELAY=10
        
        echo "更新软件源列表..."
        for i in $(seq 1 $MAX_RETRIES); do
          echo "尝试更新feeds (第 $i/$MAX_RETRIES 次)..."
          if ./scripts/feeds update -a; then
            echo "Feeds更新成功"
            break
          else
            if [ $i -lt $MAX_RETRIES ]; then
              echo "更新feeds失败，等待 $RETRY_DELAY 秒后重试..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))  # 指数退避
            else
              echo "更新feeds失败，已达最大重试次数"
              exit 1
            fi
          fi
        done

        echo "安装基础软件包..."
        ./scripts/feeds install -a

        # 安装额外工具（针对eMMC设备）
        ./scripts/feeds install e2fsprogs
        ./scripts/feeds install blkid
        ./scripts/feeds install lsblk
        ./scripts/feeds install fdisk

    - name: 配置 ImmortalWrt
      run: |
        cd immortalwrt

        # 清理选项
        if [[ "${{ github.event.inputs.clean_build }}" == "true" ]]; then
          echo "执行完全清理..."
          make clean
          rm -rf tmp .config* feeds
          
          # 添加重试逻辑以处理临时网络错误
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "尝试更新feeds (第 $i/$MAX_RETRIES 次)..."
            if ./scripts/feeds update -a; then
              echo "Feeds更新成功"
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "更新feeds失败，等待 $RETRY_DELAY 秒后重试..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))  # 指数退避
              else
                echo "更新feeds失败，已达最大重试次数"
                exit 1
              fi
            fi
          done
          
          ./scripts/feeds install -a
        fi

        # 生成默认配置
        echo "配置目标平台：${{ env.TARGET }}/${{ env.SUBTARGET }}"
        make defconfig

        # 应用设备配置
        if [ -f ../custom-configs/configs/zbtlink_z8102ax-emmc.config ]; then
          echo "应用设备专属配置..."
          cat ../custom-configs/configs/zbtlink_z8102ax-emmc.config >> .config
        else
          # 基础配置 - 针对eMMC设备优化
          echo "应用基础eMMC配置..."
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_z8102ax-emmc=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_UBIFS=y" >> .config
          echo "CONFIG_TARGET_UBIFS_FREE_SPACE_FIXUP=y" >> .config
          echo "CONFIG_TARGET_UBIFS_JOURNAL_SIZE=32" >> .config
          echo "# 系统分区大小已在 DTS 中定义，此处无需设置 PARTSIZE" >> .config
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
          echo "CONFIG_PACKAGE_kmod-mmc=y" >> .config
          echo "CONFIG_PACKAGE_e2fsprogs=y" >> .config
          echo "CONFIG_PACKAGE_fdisk=y" >> .config
          echo "CONFIG_PACKAGE_blkid=y" >> .config
          echo "CONFIG_PACKAGE_lsblk=y" >> .config
          echo "# 自动挂载大容量数据分区" >> .config
          echo "CONFIG_PACKAGE_block-mount=y" >> .config
        fi

        # 应用自定义软件包选择
        if [ -f ../custom-configs/configs/custom-packages.config ]; then
          echo "应用自定义软件包选择..."
          cat ../custom-configs/configs/custom-packages.config >> .config
        else
          # 推荐的基础软件包
          echo "添加推荐软件包..."
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-compat=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_vim-full=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
          echo "CONFIG_PACKAGE_openssh-sftp-server=y" >> .config
          echo "# 启用overlayfs以充分利用eMMC空间" >> .config
          echo "CONFIG_PACKAGE_kmod-fs-overlay=y" >> .config
          echo "CONFIG_PACKAGE_f2fs-tools=y" >> .config
        fi

        # 根据你的分区信息，添加自动挂载大容量分区的配置
        echo "添加eMMC大分区自动挂载配置..."
        echo "# eMMC大容量数据分区挂载由 block-mount 包处理，已在基础配置中启用。" >> .config

        # 最终验证配置
        echo "验证配置并解决依赖..."
        make defconfig
        make oldconfig

    - name: 下载软件包源码
      if: github.event.inputs.skip_download != 'true'
      run: |
        cd immortalwrt

        echo "开始下载软件包源码..."

        # 下载源码
        for i in {1..3}; do
          echo "尝试第 $i 次下载..."
          if make download -j$(nproc); then
            echo "下载成功！"
            break
          elif [ $i -eq 3 ]; then
            echo "下载失败，尝试单线程下载..."
            make download -j1 V=s
          fi
          sleep 5
        done

        # 清理无效的下载文件
        find dl -size -1024c -delete 2>/dev/null || true
        find dl -name "*.tmp" -delete 2>/dev/null || true

    - name: 编译 ImmortalWrt
      run: |
        cd immortalwrt

        # 计算编译线程数（留出内存空间）
        CPU_CORES=$(nproc)
        MEM_GB=$(free -g | awk '/^Mem:/{print $2}')

        # 根据内存调整并行度
        if [ $MEM_GB -lt 8 ]; then
          BUILD_JOBS=$((CPU_CORES / 2))
          echo "内存较低($MEM_GB GB)，使用 $BUILD_JOBS 个线程"
        else
          BUILD_JOBS=$((CPU_CORES))
          echo "内存充足($MEM_GB GB)，使用 $BUILD_JOBS 个线程"
        fi

        echo "开始编译 ImmortalWrt ${{ env.IMMORTALWRT_VERSION }}..."
        echo "编译设备: ${{ env.DEVICE }} (MT7981B eMMC)"
        echo "系统分区大小: ${{ env.EMMC_SYSTEM_SIZE }} MiB"
        echo "数据分区大小: ${{ env.EMMC_ROOTFS_SIZE }} MiB"

        # 编译固件
        time make -j$BUILD_JOBS V=s 2>&1 | tee build_full.log

        # 检查编译结果
        echo "=== 编译完成，检查产出文件 ==="

        # 查找固件文件
        FIRMWARE_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"

        if [ -d "$FIRMWARE_DIR" ]; then
          echo "找到产出目录，内容如下:"
          ls -la $FIRMWARE_DIR/

          # 查找所有 .bin 文件
          BIN_COUNT=$(find $FIRMWARE_DIR -type f -name "*.bin" | wc -l)
          
          if [ "$BIN_COUNT" -eq 0 ]; then
            echo "❌ 错误：编译完成但未生成任何固件文件 (.bin)"
            echo "这可能是因为："
            echo "  1. 编译过程中出现错误"
            echo "  2. 设备配置不正确"
            echo "  3. 目标设备定义缺失"
            echo ""
            echo "请检查编译日志 (build_full.log) 查看详细错误信息"
            exit 1
          fi

          # 查找特定固件
          SYSUPGRADE_FILE=$(find $FIRMWARE_DIR -name "*sysupgrade*.bin" -o -name "*${{ env.DEVICE }}*.bin" | head -1)

          if [ -n "$SYSUPGRADE_FILE" ] && [ -f "$SYSUPGRADE_FILE" ]; then
            echo "✅ 主要固件文件: $(basename $SYSUPGRADE_FILE)"
            echo "   文件大小: $(ls -lh $SYSUPGRADE_FILE | awk '{print $5}')"
            echo "   SHA256: $(sha256sum $SYSUPGRADE_FILE | cut -d' ' -f1)"

            # 检查固件是否包含eMMC支持
            if strings $SYSUPGRADE_FILE | grep -q "mmcblk"; then
              echo "✅ 固件包含eMMC驱动支持"
            else
              echo "⚠️  警告：固件可能不包含eMMC驱动"
            fi
          else
            echo "⚠️  警告：未找到sysupgrade固件，但发现了以下固件文件："
            find $FIRMWARE_DIR -type f -name "*.bin" | head -5 | while read f; do
              echo "  可用文件: $(basename $f) ($(ls -lh $f | awk '{print $5}'))"
            done
          fi
        else
          echo "❌ 产出目录不存在: $FIRMWARE_DIR"
          exit 1
        fi

    - name: 上传固件产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-${{ env.IMMORTALWRT_VERSION }}-${{ env.DEVICE }}
        path: |
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/sha256sums
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/config.buildinfo
        if-no-files-found: error
        retention-days: 90

    - name: 上传软件包
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-${{ env.IMMORTALWRT_VERSION }}-packages
        path: |
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/packages/
          immortalwrt/bin/packages/
        if-no-files-found: warn
        retention-days: 30

    - name: 上传编译日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-${{ env.IMMORTALWRT_VERSION }}-logs
        path: |
          immortalwrt/build_full.log
          immortalwrt/.config
          immortalwrt/logs/
        if-no-files-found: warn
        retention-days: 7

    - name: 显示ccache统计
      if: always()
      run: |
        echo "=== CCache 统计信息 ==="
        ccache -s
        echo "缓存目录: $CCACHE_DIR"
        du -sh $CCACHE_DIR 2>/dev/null || echo "无法统计缓存目录大小"

    - name: 创建GitHub发布（仅标签触发）
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: |
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*-sysupgrade.bin
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/sha256sums
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ImmortalWrt ${{ env.IMMORTALWRT_VERSION }} 构建 - ${{ env.DEVICE }}

          **设备信息**:
          - 芯片: MediaTek MT7981B (Filogic 820)
          - 存储: eMMC (Y0S128)
          - 系统分区: ${{ env.EMMC_SYSTEM_SIZE }} MiB (mmcblk0p6)
          - 数据分区: ${{ env.EMMC_ROOTFS_SIZE }} MiB (mmcblk0p7)

          **刷机提示**:
          1. 使用 `*-sysupgrade.bin` 文件通过原系统升级
          2. 刷机后，105G数据分区会自动挂载到 `/opt`
          3. 首次启动可能需要2-3分钟初始化
