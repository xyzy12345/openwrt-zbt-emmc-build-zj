name: Build ImmortalWrt 24.10.4 for ZBT-Z8102AX-eMMC

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-immortalwrt.yml'
      - 'configs/**'
      - 'dts/**'
      - 'target/linux/mediatek/**'
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'  # 每周日UTC 2点自动构建
  workflow_dispatch:
    inputs:
      clean_build:
        description: '完全清理构建（清除所有缓存，编译时间显著增加）'
        required: false
        default: 'false'
      skip_download:
        description: '跳过源码下载阶段（使用已有dl缓存）'
        required: false
        default: 'false'

env:
  IMMORTALWRT_REPO: "https://github.com/immortalwrt/immortalwrt"
  IMMORTALWRT_BRANCH: "master"  # master分支包含最新的24.10.4
  TARGET: "mediatek"
  SUBTARGET: "filogic"
  DEVICE_NAME: "zbtlink_z8102ax-emmc"
  DEVICE_DISPLAY_NAME: "ZBT Z8102AX (eMMC, MT7981B)"

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用稳定版本，兼容性更好
    timeout-minutes: 360    # 延长至6小时，首次编译可能需要更长时间

    steps:
    - name: 检出配置文件
      uses: actions/checkout@v4
      with:
        path: config-files
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          python3-dev \
          rsync \
          unzip \
          wget \
          zlib1g-dev \
          file \
          subversion \
          time \
          xsltproc \
          libxml-parser-perl \
          curl \
          upx
        
        # 配置ccache缓存
        sudo mkdir -p /opt/ccache
        sudo chmod 777 /opt/ccache
        echo "CCACHE_DIR=/opt/ccache" >> $GITHUB_ENV
        echo "/usr/lib/ccache" >> $GITHUB_PATH
        ccache -M 8G
        ccache -s

    - name: 克隆 ImmortalWrt 源码
      run: |
        echo "正在克隆 ImmortalWrt ${{ env.IMMORTALWRT_BRANCH }} 分支..."
        git clone ${{ env.IMMORTALWRT_REPO }} \
          --branch ${{ env.IMMORTALWRT_BRANCH }} \
          --single-branch \
          --depth=1
        
        cd immortalwrt
        
        echo "当前分支版本信息:"
        git log --oneline -2
        
        # 初始化子模块
        git submodule update --init --recursive
        
        # 复制设备树文件 (DTS) - 必需
        if [ -f ../config-files/dts/mt7981b-zbt-z8102ax-emmc.dts ]; then
          echo "复制设备树文件..."
          mkdir -p target/linux/mediatek/dts/
          cp ../config-files/dts/mt7981b-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
          echo "DTS 文件已部署"
        else
          echo "错误：未找到必需的 DTS 文件！"
          echo "请在 config-files/dts/ 目录下创建 mt7981b-zbt-z8102ax-emmc.dts 文件"
          exit 1
        fi
        
        # 复制设备定义文件 - 必需
        if [ -f ../config-files/target/linux/mediatek/image/filogic.mk ]; then
          echo "复制设备定义文件..."
          mkdir -p target/linux/mediatek/image/
          cp ../config-files/target/linux/mediatek/image/filogic.mk target/linux/mediatek/image/
          echo "设备定义文件已部署"
        else
          echo "警告：未找到自定义设备定义，将尝试使用默认配置"
        fi
        
        # 复制补丁文件（可选）
        if [ -d ../config-files/patches/ ] && [ -n "$(ls -A ../config-files/patches/ 2>/dev/null)" ]; then
          echo "复制补丁文件..."
          mkdir -p target/linux/mediatek/patches-5.15/
          cp ../config-files/patches/*.patch target/linux/mediatek/patches-5.15/ 2>/dev/null || true
        fi

    - name: 更新和安装软件源
      run: |
        cd immortalwrt
        
        echo "更新软件源..."
        ./scripts/feeds update -a
        echo "安装软件包..."
        ./scripts/feeds install -a

    - name: 配置编译选项
      run: |
        cd immortalwrt
        
        # 清理选项
        if [[ "${{ github.event.inputs.clean_build }}" == "true" ]]; then
          echo "执行完全清理构建..."
          make clean
          rm -rf tmp .config* staging_dir build_dir
        fi
        
        echo "=== 步骤1：生成基础配置 ==="
        make defconfig
        
        echo "=== 步骤2：应用设备配置 ==="
        if [ -f ../config-files/configs/zbtlink_z8102ax-emmc.config ]; then
          echo "使用自定义设备配置..."
          cat ../config-files/configs/zbtlink_z8102ax-emmc.config >> .config
        else
          echo "错误：未找到设备配置文件！"
          echo "请在 config-files/configs/ 目录下创建 zbtlink_z8102ax-emmc.config"
          exit 1
        fi
        
        # 添加必需的核心配置（确保eMMC和UBIFS支持）
        echo "=== 步骤3：添加核心配置 ==="
        cat << 'EOF' >> .config
# 核心配置 - 针对eMMC设备
CONFIG_TARGET_ROOTFS_UBIFS=y
CONFIG_TARGET_UBIFS_FREE_SPACE_FIXUP=y
CONFIG_TARGET_UBIFS_JOURNAL_SIZE=32

# eMMC驱动支持
CONFIG_PACKAGE_kmod-mmc=y
CONFIG_PACKAGE_kmod-mmc-mtk=y
CONFIG_PACKAGE_kmod-mtk-sd=y

# 文件系统支持
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_e2fsprogs=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_lsblk=y
CONFIG_PACKAGE_blkid=y

# 自动挂载数据分区
CONFIG_PACKAGE_block-mount=y

# 基础工具
CONFIG_PACKAGE_openssh-server=y
CONFIG_PACKAGE_openssh-client=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_iperf3=y

# LuCI界面
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-ssl-openssl=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y
EOF
        
        echo "=== 步骤4：应用自定义软件包 ==="
        if [ -f ../config-files/configs/custom-packages.config ]; then
          echo "添加自定义软件包..."
          cat ../config-files/configs/custom-packages.config >> .config
        fi
        
        echo "=== 步骤5：验证配置 ==="
        make defconfig
        make oldconfig
        
        # 显示关键配置
        echo "=== 关键配置检查 ==="
        echo "目标平台:"
        grep "^CONFIG_TARGET" .config | head -5
        echo "文件系统:"
        grep "UBIFS\|SQUASHFS\|EXT4" .config | head -5
        echo "eMMC驱动:"
        grep "MMC\|EMMC" .config | head -5

    - name: 下载源码包
      if: github.event.inputs.skip_download != 'true'
      run: |
        cd immortalwrt
        
        echo "开始下载源码包..."
        
        # 尝试多次下载，提高成功率
        for attempt in {1..3}; do
          echo "下载尝试 #$attempt"
          if make download -j$(nproc) 2>&1 | tee download.log; then
            echo "下载成功！"
            break
          elif [ $attempt -eq 3 ]; then
            echo "下载失败，尝试单线程下载..."
            make download -j1 V=s 2>&1 | tee download_single.log
          fi
          sleep 10
        done
        
        # 清理无效的下载文件
        find dl -size -1024c -delete 2>/dev/null || true

    - name: 编译 ImmortalWrt
      run: |
        cd immortalwrt
        
        echo "=== 编译信息 ==="
        echo "设备: ${{ env.DEVICE_DISPLAY_NAME }}"
        echo "目标: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
        echo "日期: $(date)"
        
        # 智能计算并行编译数
        CPU_CORES=$(nproc)
        MEM_GB=$(free -g | awk '/^Mem:/{print $2}')
        
        # 根据内存调整并行度
        if [ $MEM_GB -lt 6 ]; then
          BUILD_JOBS=$((CPU_CORES / 2))
          echo "内存较低 ($MEM_GB GB)，使用 $BUILD_JOBS 线程"
        elif [ $MEM_GB -lt 12 ]; then
          BUILD_JOBS=$CPU_CORES
          echo "内存中等 ($MEM_GB GB)，使用 $BUILD_JOBS 线程"
        else
          BUILD_JOBS=$((CPU_CORES * 2))
          echo "内存充足 ($MEM_GB GB)，使用 $BUILD_JOBS 线程"
        fi
        
        # 设置编译环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "=== 开始编译 ==="
        time make -j$BUILD_JOBS V=s 2>&1 | tee build.log
        
        echo "=== 编译完成 ==="
        
        # 检查编译结果
        FIRMWARE_PATH="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        
        if [ -d "$FIRMWARE_PATH" ]; then
          echo "固件输出目录内容:"
          ls -la $FIRMWARE_PATH/
          
          # 查找固件文件
          SYSUPGRADE_FILE=$(find $FIRMWARE_PATH -name "*sysupgrade*.bin" -type f | head -1)
          
          if [ -f "$SYSUPGRADE_FILE" ]; then
            echo "✅ 编译成功！"
            echo "固件文件: $(basename $SYSUPGRADE_FILE)"
            echo "文件大小: $(ls -lh "$SYSUPGRADE_FILE" | awk '{print $5}')"
            echo "MD5: $(md5sum "$SYSUPGRADE_FILE" | cut -d' ' -f1)"
            echo "SHA256: $(sha256sum "$SYSUPGRADE_FILE" | cut -d' ' -f1)"
            
            # 验证固件包含eMMC支持
            if strings "$SYSUPGRADE_FILE" | grep -q "mmcblk"; then
              echo "✅ 固件包含eMMC驱动支持"
            else
              echo "⚠️  警告：固件可能缺少eMMC驱动"
            fi
          else
            echo "❌ 未找到sysupgrade固件"
            echo "可用的bin文件:"
            find $FIRMWARE_PATH -name "*.bin" -type f | while read f; do
              echo "  - $(basename $f) ($(ls -lh "$f" | awk '{print $5}'))"
            done
          fi
        else
          echo "❌ 固件输出目录不存在"
          echo "编译可能失败，请检查build.log"
          exit 1
        fi

    - name: 上传固件产物
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: immortalwrt-${{ env.DEVICE_NAME }}-firmware
        path: |
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/sha256sums
          immortalwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/config.buildinfo
        retention-days: 30
        if-no-files-found: warn

    - name: 上传编译日志
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: immortalwrt-${{ env.DEVICE_NAME }}-logs
        path: |
          immortalwrt/build.log
          immortalwrt/.config
        retention-days: 7

    - name: 显示缓存统计
      if: always()
      run: |
        echo "=== 编译缓存统计 ==="
        ccache -s
