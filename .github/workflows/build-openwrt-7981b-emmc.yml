name: Build OpenWrt for ZBT-Z8102AX-eMMC (MT7981B)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'dts/**'
      - 'patches/**'
      - 'target/linux/mediatek/**'
      - 'scripts/**'
      - '.github/workflows/build-openwrt-7981b-emmc.yml'
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'  # 每天UTC 2点自动构建
  workflow_dispatch:  # 手动触发
    inputs:
      clean_build:
        description: 'Clean build (remove ccache)'
        required: false
        default: 'false'

env:
  OPENWRT_VERSION: "24.10.4"
  OPENWRT_BRANCH: "openwrt-24.10"
  TARGET: "mediatek"
  SUBTARGET: "filogic"
  DEVICE: "zbtlink_z8102ax-emmc"
  
  # eMMC分区设置 - 与您的DTS文件保持一致
  EMMC_PARTITION_6_SIZE: "7168"    # 7GB系统分区
  EMMC_PARTITION_7_SIZE: "107520"  # 105GB数据分区

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        path: source
        fetch-depth: 0

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-lib2to3 \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget

        # 设置ccache
        sudo apt-get install -y ccache
        echo "/usr/lib/ccache" >> $GITHUB_PATH

    - name: Clone OpenWrt
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt.git --branch v${{ env.OPENWRT_VERSION }}
        cd openwrt

        # 复制DTS文件
        if [ -f ../source/target/linux/mediatek/dts/mt7981b-zbt-z8102ax-emmc.dts ]; then
          echo "复制DTS文件..."
          mkdir -p target/linux/mediatek/dts/
          cp ../source/target/linux/mediatek/dts/mt7981b-zbt-z8102ax-emmc.dts target/linux/mediatek/dts/
        else
          echo "警告: 未找到DTS文件"
        fi

        # 检查并添加设备定义到filogic.mk
        FILOGIC_MK="target/linux/mediatek/image/filogic.mk"
        if [ -f "$FILOGIC_MK" ]; then
          echo "检查filogic.mk中是否存在zbtlink_z8102ax-emmc设备定义..."
          if ! grep -q "^define Device/zbtlink_z8102ax-emmc" "$FILOGIC_MK"; then
            echo "未找到zbtlink_z8102ax-emmc设备定义，正在添加..."
            cat >> "$FILOGIC_MK" <<'DEVICEDEF'

        define Device/zbtlink_z8102ax-emmc
          DEVICE_VENDOR := ZBT
          DEVICE_MODEL := Z8102AX (eMMC)
          DEVICE_DTS := mt7981b-zbt-z8102ax-emmc
          DEVICE_DTS_DIR := $(DTS_DIR)/mediatek
          SUPPORTED_DEVICES := zbtlink,z8102ax-emmc
          DEVICE_PACKAGES := kmod-mt7915e kmod-mt7981-firmware mt7981-wo-firmware \
            kmod-usb3 kmod-usb2 kmod-mmc-mtk kmod-fs-ext4 \
            kmod-mtk-ppe kmod-hwmon-pwmfan
          IMAGES := sysupgrade.bin
          IMAGE/sysupgrade.bin := sysupgrade-emmc | append-metadata
          UBOOTENV_IN_UBI := 1
          KERNEL_IN_UBI := 1
        endef
        TARGET_DEVICES += zbtlink_z8102ax-emmc
        DEVICEDEF
            echo "设备定义已添加到filogic.mk"
          else
            echo "zbtlink_z8102ax-emmc设备定义已存在，无需添加"
          fi
        else
          echo "错误: 未找到filogic.mk文件"
          exit 1
        fi

        # 复制配置文件
        if [ -f ../source/configs/zbtlink_z8102ax-emmc.config ]; then
          echo "复制配置文件..."
          cp ../source/configs/zbtlink_z8102ax-emmc.config .config
        else
          echo "错误: 未找到配置文件"
          exit 1
        fi

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure OpenWrt
      run: |
        cd openwrt

        # 清理缓存（如果选择）
        if [[ "${{ github.event.inputs.clean_build }}" == "true" ]]; then
          echo "执行清理构建..."
          make clean
          rm -rf tmp .config* feeds
        fi

        # 生成默认配置
        make defconfig

        # 自定义配置（如果需要）
        if [ -f ../source/configs/custom.config ]; then
          echo "应用自定义配置..."
          cat ../source/configs/custom.config >> .config
        fi

        # 验证配置（非交互式）
        yes "" | make oldconfig

    - name: Download package sources
      run: |
        cd openwrt
        make download -j$(nproc)
        find dl -size -1024c -exec rm -f {} \;

    - name: Build OpenWrt
      run: |
        cd openwrt

        # 设置编译线程数
        CPU_CORES=$(nproc)
        BUILD_JOBS=$((CPU_CORES + 1))

        # 开始编译
        echo "开始编译，使用 $BUILD_JOBS 个线程..."
        make -j$BUILD_JOBS V=s 2>&1 | tee build.log

        # 检查编译结果
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        
        # 尝试多种可能的固件文件名模式 (更具体以避免错误匹配)
        FIRMWARE_PATTERN="*${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.DEVICE }}*sysupgrade*.bin"
        FIRMWARE_FILES=$(find "$BIN_DIR" -name "$FIRMWARE_PATTERN" -type f 2>/dev/null)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "编译成功！找到固件文件:"
          echo "$FIRMWARE_FILES"
        else
          echo "编译失败！未找到预期的固件文件 (模式: $FIRMWARE_PATTERN)"
          echo "查找所有固件文件:"
          find "$BIN_DIR" -name "*.bin" -type f 2>/dev/null | head -20
          
          echo ""
          echo "检查设备定义是否正确加载:"
          echo "期望设备: ${{ env.DEVICE }}"
          
          exit 1
        fi

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-${{ env.DEVICE }}-firmware
        path: |
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/sha256sums
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/packages/*
        if-no-files-found: error
        retention-days: 7

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: openwrt-${{ env.DEVICE }}-logs
        path: |
          openwrt/build.log
          openwrt/.config
          openwrt/config.*
        if-no-files-found: warn
        retention-days: 7

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.bin
        draft: false
        prerelease: false
        generate_release_notes: true
